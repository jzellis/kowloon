# Local Testing Guide

## Running Tests Against Local Instances

The kowloon-tests suite can run against any Kowloon instance using environment variables.

### Prerequisites

1. Instances must be running:
   ```bash
   ./kowloon-instance.sh list
   docker compose ps
   ```

2. Find admin password for the instance:
   ```bash
   cat instances/<instance-id>/.env | grep ADMIN_PASSWORD
   ```

### Running Tests

**Basic usage:**
```bash
cd /Users/jzellis/Projects/kowloon-tests
BASE=http://kowloon.net ADMIN_PASSWORD=12345 node index.js
```

**Test kowloon.net:**
```bash
cd ../kowloon-tests
BASE=http://kowloon.net ADMIN_PASSWORD=12345 node index.js
```

**Test kowlunatics.net:**
```bash
cd ../kowloon-tests
BASE=http://kowlunatics.net ADMIN_PASSWORD=12345 node index.js
```

**Test with HTTPS (after setup below):**
```bash
cd ../kowloon-tests
BASE=https://kowloon.net ADMIN_PASSWORD=12345 node index.js
```

**Wipe and test (fresh start):**
```bash
WIPE=1 BASE=http://kowloon.net ADMIN_PASSWORD=12345 node index.js
```

### Test Suite Phases

The test suite runs in three phases:

1. **Phase 1: Seeding** - Creates users, circles, posts, groups, events, pages, bookmarks
2. **Phase 2: Collection Tests** - Tests all collection endpoints
3. **Phase 3: Visibility Tests** - Verifies access control and privacy settings

Tests include coverage for all ActivityPub verbs:
- Create, Update, Delete
- Follow, Unfollow, Add, Remove
- React (Like), Reply
- Join, Leave, Invite, Accept, Reject
- Block, Mute, Flag, Undo

## Setting Up Local HTTPS

For local development with /etc/hosts entries, use mkcert to generate trusted SSL certificates.

### 1. Install mkcert

```bash
brew install mkcert
mkcert -install
```

This creates a local Certificate Authority (CA) that your browser trusts.

### 2. Generate Certificates

Run the automated setup script:

```bash
./setup-local-https.sh
```

This will:
- Generate SSL certificates for all your instances (kowloon.net, kowlunatics.net, etc.)
- Create Traefik TLS configuration
- Place certificates in `./certs/` directory
- Create `./traefik/tls.yml` configuration file

### 3. Rebuild Instance Configuration

Update the override file to enable HTTPS for existing instances:

```bash
./kowloon-instance.sh rebuild
```

This updates all instances with HTTPS-enabled Traefik labels.

### 4. Restart Traefik

```bash
docker compose restart traefik
```

Wait a few seconds for Traefik to pick up the new configuration.

### 5. Test HTTPS

Open in your browser:
- https://kowloon.net
- https://kowlunatics.net

You should see a valid certificate with no browser warnings!

### Troubleshooting HTTPS

**Certificate not found:**
```bash
ls -la certs/
ls -la traefik/
```

Ensure both directories exist and contain files.

**Traefik not loading config:**
```bash
docker compose logs traefik | grep -i tls
```

Look for messages about loading certificates.

**Browser still shows warning:**
```bash
# Reinstall the local CA
mkcert -uninstall
mkcert -install
```

Then restart your browser completely.

**Check Traefik dashboard:**

Visit http://localhost:8080 and check:
- HTTP Routers tab - should show both `instance-name` and `instance-name-secure`
- TLS tab - should show your certificates

## Federation Testing

Test federation between two local instances:

### Setup

```bash
# Both instances should be running with HTTPS
docker compose ps

# Verify both are accessible
curl -k https://kowloon.net/health
curl -k https://kowlunatics.net/health
```

### Manual Federation Test

1. Open https://kowloon.net in one browser
2. Open https://kowlunatics.net in another (or private window)
3. Create users on both instances
4. Try following a user from one instance to another using their full handle: `@username@kowloon.net`

### Automated Federation Test

```bash
cd ../kowloon-tests

# Run test-federation.js (if available)
SERVER_A=https://kowloon.net \
SERVER_B=https://kowlunatics.net \
ADMIN_PASSWORD=12345 \
node test-federation.js
```

## Environment Variables Reference

### Test Suite Variables

- `BASE` - Base URL of the Kowloon instance (e.g., `http://kowloon.net`)
- `ADMIN_USERNAME` - Admin username (default: `admin`)
- `ADMIN_PASSWORD` - Admin password (required, from instance .env file)
- `WIPE` - Set to `1` to wipe database before testing

### Instance Variables

Each instance has its own `.env` file in `instances/<instance-id>/.env`:

```bash
INSTANCE_ID=kowloon-net_63f81abc
DOMAIN=kowloon.net
SITE_TITLE=Kowloon Test
ADMIN_EMAIL=admin@kowloon.net
ADMIN_PASSWORD=12345
JWT_SECRET=<auto-generated>
MONGO_URI=mongodb://...
S3_BUCKET=kowloon-kowloon-net-63f81abc
```

## Tips

### Quick Check All Instances

```bash
# List all running instances
docker compose ps | grep kowloon-

# Check all instance health
for domain in kowloon.net kowlunatics.net; do
  echo "=== $domain ==="
  curl -s http://$domain/health | jq
done
```

### View Logs During Tests

```bash
# In one terminal, watch logs
./kowloon-instance.sh logs

# In another terminal, run tests
cd ../kowloon-tests
BASE=http://kowloon.net ADMIN_PASSWORD=12345 node index.js
```

### Reset Instance for Clean Test

```bash
# Stop instance
./kowloon-instance.sh stop kowloon.net

# Connect to MongoDB and drop the database
docker exec -it kowloon-mongodb mongosh -u kowloon -p

# In mongosh:
use kowloon_kowloon-net_63f81abc
db.dropDatabase()
exit

# Restart instance
./kowloon-instance.sh start kowloon.net

# Run tests with fresh data
cd ../kowloon-tests
BASE=http://kowloon.net ADMIN_PASSWORD=12345 node index.js
```

## See Also

- [MULTI_INSTANCE.md](MULTI_INSTANCE.md) - Multi-instance architecture
- [QUICKSTART.md](QUICKSTART.md) - Quick start guide
- [DOCKER.md](DOCKER.md) - Docker basics
- kowloon-tests README - Test suite documentation
